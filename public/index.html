<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>MemoZap ‚Äî Chat</title>

<!-- FONTES E ESTILOS -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="style.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body {
  margin:0; padding:0;
  font-family:'Roboto',sans-serif;
  background:#fff; color:#000;
}
.app { display:flex; height:100vh; overflow:hidden; background:#fff; }
.main { flex:1; display:flex; flex-direction:column; justify-content:flex-end; padding:15px; }
.chat-header {
  display:flex; justify-content:space-between; align-items:center;
  padding-bottom:10px; border-bottom:1px solid #ccc;
}
.avatar.small {
  width:45px; height:45px;
  background:#23a6a0; color:#fff;
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-weight:600; cursor:default;
  overflow:hidden;
}
.avatar.small img {
  width:100%; height:100%;
  object-fit:cover; border-radius:50%;
}
.active-name { font-weight:600; }
.active-status { font-size:0.85rem; color:#666; }
.status-dot { width:10px; height:10px; border-radius:50%; margin-right:6px; }
.last-seen { font-size:0.75rem;color:#555; margin-left:6px; }
.messages { flex:1; overflow-y:auto; margin-bottom:10px; text-align:center; color:#555; }

.input-area-wrapper { display:flex; flex-direction:column; gap:5px; }
.input-area {
  display:flex; gap:10px; align-items:center;
  background:#f9f9f9; padding:10px;
  border-radius:30px; box-shadow:0 0 3px rgba(0,0,0,0.1);
  flex-wrap:nowrap;
}
.input-area input[type=text] {
  flex:3; padding:10px; border-radius:25px;
  border:1px solid #ccc; outline:none; min-width:0;
}
.btn-toggle {
  text-align:center; cursor:pointer;
  font-size:1.2rem; color:#05635f; user-select:none;
}
.btn-group {
  display:flex; gap:5px; flex:2;
  overflow:hidden; max-height:0; opacity:0;
  transition:max-height 0.3s ease, opacity 0.3s ease;
}
.btn-group.show { max-height:60px; opacity:1; }
.btn-group button {
  flex:1; min-width:60px; padding:10px;
  border:none; border-radius:25px;
  background:#05635f; color:#fff; cursor:pointer; transition:0.3s;
}
.btn-group button:hover { background:#034c4a; }

.fab {
  position:fixed; bottom:70px; right:15px;
  background:#fff; color:#05635f;
  border:none; border-radius:50%;
  width:60px; height:60px;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 4px 8px rgba(0,0,0,0.15);
  z-index:1000; cursor:pointer;
  transition:all 0.3s ease;
}
.fab:hover { background:#f1f1f1; transform:scale(1.05); }

.modal {
  display:none; position:fixed; z-index:2000;
  left:0; top:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6);
}
.modal-content {
  background:#fff; margin:50px auto; padding:15px;
  border-radius:10px; width:90%; max-width:600px;
  height:400px; position:relative;
  display:flex; flex-direction:column;
}
.modal-close {
  position:absolute; top:10px; right:15px;
  font-size:24px; font-weight:bold; color:#333; cursor:pointer;
}
#map { flex:1; width:100%; border-radius:10px; margin-top:10px; }
#addressInput {
  padding:8px; border-radius:8px;
  border:1px solid #ccc; margin-bottom:5px;
}

@media (max-width:480px){
  .input-area input[type=text] { font-size:0.95rem; }
  .btn-group button { font-size:0.85rem; padding:8px; }
}
</style>
</head>

<body>
<div class="app">
  <main class="main">
    <!-- CABE√áALHO -->
    <header class="chat-header">
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="status-dot" id="contactStatusDot" style="background:red"></div>
        <div id="contactAvatar" class="avatar small">?</div>
        <div>
          <div class="active-name" id="contactName">Contato</div>
          <div class="active-status" id="contactStatus">Offline</div>
          <div class="last-seen" id="contactLastSeen">√öltimo visto: --:--</div>
        </div>
      </div>

      <!-- AVATAR DO USU√ÅRIO LOGADO -->
      <div id="myProfileAvatar" class="avatar small" title="Meu perfil">üë§</div>

      <div class="chat-header-right">
        <button class="icon-btn" title="Anexar arquivo" id="uploadBtn">üìé</button>
        <a href="auth.html"><button class="icon-btn" title="Mais">‚ãØ</button></a>
        <input type="file" id="fileInput" hidden>
      </div>
    </header>

    <!-- MENSAGENS -->
    <div id="messages" class="messages" aria-live="polite">Carregando conversa...</div>

    <!-- √ÅREA DE DIGITA√á√ÉO -->
    <div class="input-area-wrapper">
      <div class="input-area">
        <input type="text" id="msgInput" placeholder="Digite uma mensagem..." />
      </div>
      <div class="btn-toggle" id="toggleBtns">^</div>
      <div class="btn-group" id="extraBtns">
        <button id="openMapBtn">üó∫Ô∏è Abrir mapa</button>
        <button id="shareLiveLocation">üìç Localiza√ß√£o</button>
      </div>
    </div>
  </main>
</div>

<!-- BOT√ÉO FLUTUANTE -->
<button class="fab" id="newChatBtn" title="Enviar/novo chat">Ôºã</button>

<!-- MODAL DO MAPA -->
<div id="mapModal" class="modal">
  <div class="modal-content">
    <span id="closeMapModal" class="modal-close">&times;</span>
    <input type="text" id="addressInput" placeholder="Digite um endere√ßo e pressione Enter" />
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module">
import { auth, db } from './firebaseConfig.js';
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
import { doc, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
import { loadChatMessages, sendMessage } from './messages.js';

let currentListener = null;
let selectedContact = null;
let currentUser = null;
const messagesDiv = document.getElementById('messages');
const myProfileAvatar = document.getElementById('myProfileAvatar');

// üîπ Atualiza status do usu√°rio logado
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'auth.html';
    return;
  }
  currentUser = user;

  const userRef = doc(db, "users", user.uid);
  await updateDoc(userRef, { status: "online", lastSeen: new Date() });

  // üî∏ Atualiza√ß√£o autom√°tica do avatar do perfil
  onSnapshot(userRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.data();

    if (data.profilePic) {
      myProfileAvatar.innerHTML = `<img src="${data.profilePic}" alt="Meu perfil">`;
    } else if (data.firstName) {
      myProfileAvatar.textContent = data.firstName[0].toUpperCase();
    } else {
      myProfileAvatar.textContent = 'üë§';
    }
  });

  // Clique no pr√≥prio avatar
  myProfileAvatar.style.cursor = 'pointer';
  myProfileAvatar.addEventListener('click', () => {
    localStorage.setItem("profileToEditUid", user.uid);
    window.location.href = "/upload-profile.html";
  });

  window.addEventListener('beforeunload', async () => {
    await updateDoc(userRef, { status: "offline", lastSeen: new Date() });
  });
});

// üîπ Carrega contato selecionado
window.addEventListener('DOMContentLoaded', () => {
  const newContact = localStorage.getItem('newContact');
  const storedContact = localStorage.getItem('selectedContact');
  let contactData = newContact ? JSON.parse(newContact) : storedContact ? JSON.parse(storedContact) : null;

  if (!contactData) {
    window.location.href = 'contacts.html';
    return;
  }

  localStorage.setItem('selectedContact', JSON.stringify(contactData));
  localStorage.removeItem('newContact');
  selectedContact = contactData;

  const avatarEl = document.getElementById('contactAvatar');
  const nameEl = document.getElementById('contactName');
  const statusText = document.getElementById('contactStatus');
  const statusDot = document.getElementById('contactStatusDot');
  const lastSeenEl = document.getElementById('contactLastSeen');

  // üëâ Mostra o primeiro nome no lugar de "Contato"
  const firstName = selectedContact.firstName ||
    (selectedContact.name ? selectedContact.name.split(" ")[0] : null) ||
    selectedContact.email || "Contato";

  nameEl.textContent = firstName;

  // üëâ Mostra avatar (foto ou inicial)
  const initial = firstName[0].toUpperCase();
  if (selectedContact.profilePic) {
    avatarEl.innerHTML = `<img src="${selectedContact.profilePic}" alt="${firstName}">`;
  } else {
    avatarEl.innerHTML = initial;
    avatarEl.style.background = "#23a6a0";
    avatarEl.style.color = "#fff";
  }

  // Busca dados no Firestore
  const contactUid = selectedContact.userUid || selectedContact.uid;
  if (contactUid) {
    const contatoRef = doc(db, "users", contactUid);

    if (currentListener) currentListener();
    currentListener = loadChatMessages(contactUid, messagesDiv);

    onSnapshot(contatoRef, snap => {
      if (!snap.exists()) return;
      const data = snap.data();
      const online = data.status === "online";
      statusDot.style.background = online ? "green" : "red";
      statusText.textContent = online ? "Online" : "Offline";

      if (!online && data.lastSeen) {
        const d = data.lastSeen.toDate ? data.lastSeen.toDate() : new Date(data.lastSeen);
        lastSeenEl.textContent = `√öltimo visto: ${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`;
      }

      if (data.profilePic) {
        avatarEl.innerHTML = `<img src="${data.profilePic}" alt="${firstName}">`;
      }
    });
  }
});

// üîπ Envio de mensagens
const msgInput = document.getElementById('msgInput');
const fabBtn = document.getElementById('newChatBtn');

function sendMessageWrapper() {
  const text = msgInput.value.trim();
  if (!text || !selectedContact) return;
  sendMessage(text, selectedContact, messagesDiv);
  msgInput.value = '';
  updateFabState();
}

function updateFabState() {
  const hasText = msgInput.value.trim().length > 0;
  if (hasText) {
    fabBtn.textContent = 'üì©';
    fabBtn.onclick = sendMessageWrapper;
  } else {
    fabBtn.textContent = 'Ôºã';
    fabBtn.onclick = () => window.location.href = 'contacts.html';
  }
}

msgInput.addEventListener('input', updateFabState);
msgInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && msgInput.value.trim()) {
    e.preventDefault();
    sendMessageWrapper();
  }
});
updateFabState();

// üîπ Bot√µes extras
const toggleBtns = document.getElementById('toggleBtns');
const extraBtns = document.getElementById('extraBtns');
toggleBtns.addEventListener('click', () => {
  extraBtns.classList.toggle('show');
  toggleBtns.textContent = extraBtns.classList.contains('show') ? 'v' : '^';
});
</script>

<!-- M√ìDULOS -->
<script type="module" src="./user.js"></script>
<script type="module" src="./messages.js"></script>
<script type="module" src="./reply.js"></script>
<script type="module" src="./chat.js"></script>

</body>
</html>
